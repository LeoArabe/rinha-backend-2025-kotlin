# Configurações da Aplicação Rinha Backend 2025
# Otimizada para GraalVM Native e alta performance

server:
  port: ${APP_PORT:8080}
  netty:
    connection-timeout: 2s
    h2c-max-content-length: 1KB
  compression:
    enabled: false # Sem compressão para payloads pequenos da Rinha

spring: # ESTE É O BLOCO 'spring' PRINCIPAL
  application:
    name: rinha-backend-2025

  # >>>>> CORREÇÃO AQUI: spring.native MOVIDO PARA DENTRO DO BLOCO 'spring' PRINCIPAL <<<<<
  native:
    remove-yaml-support: false # Garante que o suporte a YAML seja mantido

  # Configuração MongoDB Reativa (Default Profile: usa localhost como fallback)
  data:
    mongodb:
      uri: ${SPRING_DATA_MONGODB_URI:mongodb://localhost:27017/rinhaDB}
      auto-index-creation: true

  # Configuração Redis Reativa (Default Profile)
  redis:
    host: ${REDIS_HOST:localhost}
    port: ${REDIS_PORT:6379}
    timeout: 2s # Mantido 2s, 5s é do perfil prod
    lettuce:
      pool:
        max-active: 8 # Ajuste do pool
        max-wait: -1ms # Espera infinita
        max-idle: 8
        min-idle: 0
      shutdown-timeout: 3s

  # WebFlux Configurações
  webflux:
    base-path: /

  # Actuator para Health Checks
  management:
    endpoints:
      web:
        exposure:
          include: health,info
        base-path: /actuator
    endpoint:
      health:
        show-details: when-authorized
    health:
      redis:
        enabled: true
      mongo:
        enabled: true

# Configurações dos Payment Processors (Default Profile)
payment:
  processors:
    default:
      url: ${PROCESSOR_DEFAULT_URL:http://payment-processor-default:8080}
      fee-percentage: 0.05
      name: "default"
    fallback:
      url: ${PROCESSOR_FALLBACK_URL:http://payment-processor-fallback:8080}
      fee-percentage: 0.15
      name: "fallback"

  # Configurações do Circuit Breaker (Default Profile)
  circuit-breaker:
    failure-threshold: ${CIRCUIT_BREAKER_FAILURE_THRESHOLD:5}
    recovery-timeout-seconds: ${CIRCUIT_BREAKER_RECOVERY_TIMEOUT:30}
    request-timeout-seconds: ${CIRCUIT_BREAKER_REQUEST_TIMEOUT:4}

  # Configurações dos Workers (Default Profile)
  workers:
    concurrency: ${WORKER_CONCURRENCY:16}
    health-check-interval-seconds: 5
    retry-max-attempts: 3
    retry-backoff-seconds: 2

# Configurações de Instância (para Leader Election) (Default Profile)
app:
  instance-id: ${INSTANCE_ID:API-1}
  leader-election:
    key: "rinha:leader:health-checker"
    ttl-seconds: 10 # Do compose antigo, mais consistente com Redis TTL
  outbox:
    processing-delay-ms: 200
    max-parallel-events: 16
    leader-ttl-seconds: 5 # Novo, do seu OutboxRelay

# Logging otimizado para GraalVM (Default Profile)
logging:
  level:
    # Nível padrão para nossa aplicação
    com.estagiario.gobots.rinha_backend: INFO
    # Nível específico para os workers, que são mais "falantes"
    com.estagiario.gobots.rinha_backend.application.worker: INFO
    # Silenciando bibliotecas externas
    org.springframework: WARN
    org.mongodb.driver: WARN
    reactor.netty: WARN

---
# Profile de Produção (usado nos containers)
spring: # ESTE É O BLOCO 'spring' PARA O PERFIL PROD
  config:
    activate:
      on-profile: prod

  # MongoDB otimizado para produção (usa variável de ambiente)
  data:
    mongodb:
      uri: ${SPRING_DATA_MONGODB_URI} # Espera a URI do ambiente
      auto-index-creation: false

  # Redis otimizado para produção
  redis:
    host: ${REDIS_HOST:redis} # Espera o host do ambiente, com fallback 'redis'
    port: ${REDIS_PORT:6379}
    timeout: 5s # MUDANÇA: Aumentado para 5s, consistente com o que discutimos
    lettuce:
      pool:
        max-active: 32 # Otimizado para prod
        max-idle: 16
        min-idle: 4

# Logging em produção (pode ser sobrescrito pelas variáveis de ambiente do Compose)
logging:
  level:
    # Mantém os workers em INFO para vermos quando lotes são processados
    com.estagiario.gobots.rinha_backend.application.worker: INFO
    # Mantém o resto da nossa app em INFO
    com.estagiario.gobots.rinha_backend: INFO

---
# Profile de desenvolvimento/teste (para usar localmente, se não Docker)
spring: # ESTE É O BLOCO 'spring' PARA O PERFIL DEV
  config:
    activate:
      on-profile: dev

# Configurações locais para desenvolvimento
payment:
  processors:
    default:
      url: ${PROCESSOR_DEFAULT_URL:http://localhost:8001}
    fallback:
      url: ${PROCESSOR_FALLBACK_URL:http://localhost:8002}

logging:
  level:
    # Em dev, queremos ver todos os detalhes
    com.estagiario.gobots.rinha_backend: DEBUG
    org.springframework.data.mongodb: DEBUG # Útil para ver as queries
    reactor.netty.http.client: DEBUG # Útil para depurar chamadas HTTP